<?php
##############################################################################
#     Caching script for PHP                                                 #
#     Copyright (C) 2008  Darrin Yeager                                      #
#     http://www.dyeager.org                                                 #
#                                                                            #
#                                                                            #
# Redistribution and use in source and binary forms, with or without         #
# modification, are permitted provided that the following conditions         #
# are met:                                                                   #
#                                                                            #
#   1. Redistributions of source code must retain the above copyright        #
#      notice, this list of conditions and the following disclaimer.         #
#                                                                            #
#   2. Redistributions in binary form must reproduce the above copyright     #
#      notice, this list of conditions and the following disclaimer in the   #
#      documentation and/or other materials provided with the distribution.  #
#                                                                            #
#   3. Redistributions of modified versions must carry prominent notices     #
#      stating that you changed the files and the date of any change.        #
#                                                                            #
#   4. Neither the name of Darrin Yeager nor the names of any contributors   #
#      may be used to endorse or promote products derived from this software #
#      without specific prior written permission.                            #
#                                                                            #
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS        #
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT          #
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR      #
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT       #
# OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,      #
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED   #
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR     #
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF     #
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING       #
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS         #
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.               #
##############################################################################
#
# Change this if you're using something other than UTF-8 (which you really shouldn't)
$charset = "utf-8";
# Change this age if you want your pages to expire earlier or later than 1 minutes.
$max_age_minutes = 1;

#Nothing to modify below this line.
$is304 = false;
$mime = "text/html";

# Get the file stats and compute last-modified time.
$filestats = @stat($_SERVER["SCRIPT_FILENAME"]);
$lastmod = $filestats[9] - date('Z');  #Convert Local time -> GMT
$lastmodified = date("D, d M Y H:i:s", $lastmod) . " GMT";

# ETag is "inode-lastmodtime-filesize" - See PHP stat function for more detail
$etag = 'W/"' . dechex($filestats[1]) . "-" . dechex($lastmod) . "-" . dechex($filestats[7]) . '"';

# Check HTTP_IF_NONE_MATCH
# and report a 304 Not Modified header if they match.
if (isset ($_SERVER["HTTP_IF_NONE_MATCH"])) {
	if ($etag === stripslashes($_SERVER["HTTP_IF_NONE_MATCH"])) 
		$is304 = true;
}

# Check HTTP_IF_MODIFIED_SINCE
# and report a 304 Not Modified header if they match.
if ((isset ($_SERVER["HTTP_IF_MODIFIED_SINCE"]))) {
	#Old Netscape and/or IE can put "; length=xyz" after the "GMT" in date
	#which completly violates the specs, so we have to strip it out.
	if (preg_replace('/;.*$/', '', $_SERVER["HTTP_IF_MODIFIED_SINCE"]) === $lastmodified)
		$is304 = true;
}

# Get max age in seconds.
$max_age = $max_age_minutes * 60;

header("Cache-Control: max-age=$max_age, s-maxage=$max_age");
header("Expires: " . date("D, d M Y H:i:s",time() + $max_age - date('Z')) . " GMT");
header("X-PHP-Caching: 1.0.1");

# If for some reason we didn't get a valid file modification time
# from the stat function, or it errored out, DO NOT send the ETag
# header as it will not be valid. Valid in this since is defined
# as modified AFTER Dec 24, 1999.
if ($lastmod > 946080000) { 	# 946080000 = Dec 24, 1999 4PM
	header("ETag: " . $etag);
	header("Last-Modified: " . $lastmodified);
}

if ($is304) {
	if (isset($_SERVER["SERVER_PROTOCOL"]) && $_SERVER["SERVER_PROTOCOL"] == "HTTP/1.1") 
		header("HTTP/1.1 304 Not Modified");
	else
		header("HTTP/1.0 304 Not Modified");
	header("Connection: close");
	exit;
}

header("Content-Type: $mime;charset=$charset");
?>